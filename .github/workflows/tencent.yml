name: Tencent Kubernetes Engine

on:
  push:
    branches: [ "main" ]

env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      # üß© 1Ô∏è‚É£ R√©cup√©ration du code
      - name: Checkout
        uses: actions/checkout@v4

      # üèóÔ∏è 2Ô∏è‚É£ Construction de l‚Äôimage Docker
      - name: Build Docker image
        run: |
          docker build -t ${TKE_IMAGE_URL}:${GITHUB_SHA} .

      # üîê 3Ô∏è‚É£ Connexion au registre Tencent Cloud
      - name: Login to Tencent Container Registry
        run: |
          docker login -u "${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }}" -p "${{ secrets.TKE_REGISTRY_PASSWORD }}" ccr.ccs.tencentyun.com

      # üì§ 4Ô∏è‚É£ Publication de l‚Äôimage sur le registre
      - name: Push image to Tencent Cloud Registry
        run: |
          docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}

      # ‚öôÔ∏è 5Ô∏è‚É£ Installation de kustomize
      - name: Set up Kustomize
        run: |
          curl -sLo kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
          chmod +x ./kustomize

      # ‚òÅÔ∏è 6Ô∏è‚É£ Configuration de l‚Äôacc√®s au cluster TKE
      - name: Configure kubectl for TKE
        env:
          TENCENT_CLOUD_SECRET_ID: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
          TENCENT_CLOUD_SECRET_KEY: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
          TKE_REGION: ${{ env.TKE_REGION }}
          TKE_CLUSTER_ID: ${{ env.TKE_CLUSTER_ID }}
        run: |
          curl -sSL https://tencentcloud-cli-1259648581.cos.ap-guangzhou.myqcloud.com/tke-eksctl.sh | bash
          tke-eksctl update-kubeconfig --region ${TKE_REGION} --cluster-id ${TKE_CLUSTER_ID}

      # üöÄ 7Ô∏è‚É£ D√©ploiement de l‚Äôimage sur TKE
      - name: Deploy to TKE
        run: |
          ./kustomize edit set image ${TKE_IMAGE_URL}:${GITHUB_SHA}
          ./kustomize build . | kubectl apply -f -
          kubectl rollout status deployment/${DEPLOYMENT_NAME}
          kubectl get services -o wide
